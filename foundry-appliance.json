{
  "builders": [
    {
      "vm_name": "foundry-appliance",
      "type": "vsphere-iso",
      "guest_os_type": "ubuntu64Guest",

      "vcenter_server": "{{ user `vcenter_server` }}",
      "username": "{{ user `vcenter_username` }}",
      "password": "{{ user `vcenter_password` }}",
      "insecure_connection": true,

      "cluster": "{{ user `cluster` }}",
      "datastore": "{{ user `datastore` }}",

      "iso_url": "{{ user `iso_url` }}",
      "iso_checksum": "{{ user `iso_checksum` }}",

      "ssh_username": "{{ user `ssh_username` }}",
      "ssh_password": "{{ user `ssh_password` }}",
      "ssh_timeout": "30m",

      "http_directory": "http",

      "cpus": 2,
      "ram": 4096,

      "storage": [
        {
          "disk_size": 20000,
          "disk_thin_provisioned": true
        }
      ],

      "network_adapters": [
        {
          "network": "home-net",
          "network_card": "vmxnet3"
        }
      ],

      "boot_wait": "5s",
      "boot_command": [
        "<enter><enter><f6><esc><wait> ",
        "ipv6.disable=1 autoinstall ds=nocloud-net;s=http://{{ .HTTPIP }}:{{ .HTTPPort }}/",
        "<enter>",
        "<wait10><wait10><wait10><wait10><wait10><wait10>"
      ],
      "shutdown_command": "echo '{{ user `ssh_password` }}'|sudo -S shutdown -P now"
    }
  ],
  "provisioners": [
    {
      "type": "file",
      "source": "./foundry",
      "destination": "/home/{{ user `ssh_username` }}"
    },
    {
      "type": "shell",
      "execute_command": "echo '{{ user `ssh_password` }}' | {{.Vars}} sudo -E -S bash '{{.Path}}'",
      "expect_disconnect": true,
      "inline": [
        "echo '{{ user `appliance_version` }}' > /etc/appliance_version",
        "swapoff -a",
        "sed -i -r 's/(\\/swap\\.img.*)/#\\1/' /etc/fstab",
        "apt update",
        "apt full-upgrade -y",
        "snap install microk8s --classic --channel=1.20/stable",
        "microk8s status --wait-ready",
        "microk8s enable dns storage ingress host-access metrics-server",
        "usermod -a -G microk8s {{ user `ssh_username` }}",
        "chown -f -R {{ user `ssh_username` }}:{{ user `ssh_username` }} ~/.kube",
        "sed -i '/^DNS\\.5.*/a DNS.6 = foundry.local' /var/snap/microk8s/current/certs/csr.conf.template",
        "snap install kubectl --classic",
        "snap install helm --classic",
        "curl -sLo /usr/local/bin/cfssl https://github.com/cloudflare/cfssl/releases/download/v1.5.0/cfssl_1.5.0_linux_amd64",
        "curl -sLo /usr/local/bin/cfssljson https://github.com/cloudflare/cfssl/releases/download/v1.5.0/cfssljson_1.5.0_linux_amd64",
        "chmod +x /usr/local/bin/cfssl*",
        "sudo -u {{ user `ssh_username` }} git clone https://github.com/jaggedmountain/k-alias.git",
        "(cd /usr/local/bin && ln -s ~/k-alias/[h,k]* .)",
        "chmod -x /etc/update-motd.d/00-header",
        "chmod -x /etc/update-motd.d/10-help-text",
        "sed -i -r 's/(ENABLED=)1/\\10/' /etc/default/motd-news",
        "ln -s /home/foundry/foundry/foundry-banner /etc/update-motd.d/05-foundry-banner",
        "sed -i 's/{version}/{{ user `appliance_version` }}/' ~/foundry/web/index.html",
        "echo -e 'Foundry Appliance {{ user `appliance_version` }} \\\\n \\l \\n' > /etc/issue",
        "systemctl disable --now systemd-resolved",
        "rm -f /etc/resolv.conf",
        "echo 'nameserver 8.8.8.8' > /etc/resolv.conf",
        "apt install -y dnsmasq avahi-daemon jq nfs-common sshpass",
        "mv ~/foundry/dnsmasq.conf /etc/dnsmasq.d/foundry.conf",
        "chown root:root /etc/dnsmasq.d/foundry.conf",
        "systemctl restart dnsmasq",
        "sed -i -r 's/(GRUB_CMDLINE_LINUX_DEFAULT=).*/\\1\"quiet ipv6.disable=1\"/' /etc/default/grub",
        "update-grub",
        "reboot"
      ]
    },
    {
      "type": "shell",
      "inline": [
        "ssh-keygen -t rsa -f ~/.ssh/id_rsa -q -N ''",
        "microk8s status --wait-ready",
        "microk8s config -l > ~/.kube/config",
        "chmod 600 ~/.kube/config",
        "~/foundry/certs/generate-certs.sh"
      ]
    },
    {
      "type": "shell",
      "execute_command": "echo '{{ user `ssh_password` }}' | {{.Vars}} sudo -E -S bash '{{.Path}}'",
      "inline": [
        "cp ~/foundry/certs/root-ca.pem /usr/local/share/ca-certificates/foundry-appliance-root-ca.crt",
        "update-ca-certificates",
        "sed -i -r 's/(preserve_hostname: )false/\\1true/' /etc/cloud/cloud.cfg",
        "(cd /etc/cloud/cloud.cfg.d && rm -f 99-installer.cfg curtin-preserve-sources.cfg subiquity-disable-cloudinit-networking.cfg)",
        "systemctl restart avahi-daemon"
      ]
    },
    {
      "type": "shell",
      "inline": [
        "~/foundry/setup-foundry"
      ]
    }
  ],
  "variables": {
    "iso_url": "http://releases.ubuntu.com/20.04/ubuntu-20.04.2-live-server-amd64.iso",
    "iso_checksum": "sha256:d1f2bf834bbe9bb43faf16f9be992a6f3935e65be0edece1dee2aa6eb1767423",
    "ssh_username": "foundry",
    "ssh_password": "foundry",
    "appliance_version": "",
    "vcenter_server": "",
    "vcenter_username": "",
    "vcenter_password": "",
    "cluster": "",
    "datastore": ""
  }
}
